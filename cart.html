<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SkySail Drones - Shopping Cart</title>
    <link rel="icon" href="./images/image-removebg-preview 2.png" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Montserrat", sans-serif;
      }
      /* Mobile bottom navigation */
      .mobile-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #e5e7eb;
        padding: 0.5rem 0;
        z-index: 50;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      }
      .mobile-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 0.5rem;
        text-decoration: none;
        color: #6b7280;
        font-size: 0.75rem;
        transition: color 0.2s;
      }
      .mobile-nav-item.active {
        color: #9333ea;
      }
      .mobile-nav-item svg {
        width: 1.5rem;
        height: 1.5rem;
      }
      /* Add padding to main content to account for bottom nav */
      @media (max-width: 768px) {
        body {
          padding-bottom: 4.5rem;
        }
        header .flex.items-center.gap-4 {
          flex-wrap: wrap;
          gap: 0.5rem;
        }
        header .flex.items-center.gap-4 > * {
          font-size: 0.75rem;
          padding: 0.5rem 0.75rem;
        }
        #user-label {
          display: none;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900 min-h-screen">
    <script src="./auth-role.js"></script>
    <script>
      // Require login for all user types - check after DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        const user = getCurrentUser();
        // Check for id_user, id, or username (handle different API response formats)
        if (!user || (!user.id_user && !user.id && !user.username)) {
          console.log("No user found, redirecting to login");
          window.location.href = "./login.html";
          return;
        }
        console.log("User authenticated:", user);
      });
    </script>

    <div class="min-h-screen flex flex-col">
      <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div class="flex items-center justify-between">
            <a href="./drones.html" class="flex items-center gap-2">
              <img src="./images/logolight.png" alt="SkySail Logo" class="h-10 w-auto" />
            </a>
            <div class="flex items-center gap-2 sm:gap-4 text-sm">
              <a
                href="./drones.html"
                class="px-3 sm:px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium text-xs sm:text-sm transition"
              >
                <span class="hidden sm:inline">Continue Shopping</span>
                <span class="sm:hidden">Shop</span>
              </a>
              <span id="user-label" class="hidden lg:inline text-gray-600 text-xs sm:text-sm"></span>
              <button
                onclick="logoutAndRedirect('./login.html')"
                class="hidden sm:inline-block px-3 sm:px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium text-xs sm:text-sm transition"
              >
                Logout
              </button>
            </div>
          </div>
        </div>
      </header>

      <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Shopping Cart</h2>

        <div id="cart-content">
          <div class="text-center text-gray-500 py-12">Loading cart...</div>
        </div>
      </main>
    </div>

    <script>
      const API_BASE = "https://skysaildrone.solof.shop";
      const DRONES_API = API_BASE + "/api-drones.php";

      function formatMoney(value) {
        const num = Number(value || 0);
        return "₱" + num.toLocaleString("en-PH", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function imageUrlFromPath(path) {
        if (!path) return API_BASE + "/uploads/default-drone.png";
        if (path.startsWith("http")) return path;
        
        // Use serve-image.php to handle multiple possible locations
        return API_BASE + "/serve-image.php?path=" + encodeURIComponent(path);
      }

      async function fetchJson(url, options = {}) {
        const res = await fetch(url, options);
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
          throw new Error(data.message || "Request failed");
        }
        return data;
      }

      async function loadCart() {
        const cartContent = document.getElementById("cart-content");
        const cart = JSON.parse(localStorage.getItem("skysail_cart") || "{}");

        if (Object.keys(cart).length === 0) {
          cartContent.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg p-12 text-center">
              <svg class="w-24 h-24 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
              </svg>
              <h3 class="text-2xl font-bold text-gray-900 mb-2">Your cart is empty</h3>
              <p class="text-gray-600 mb-6">Start adding drones to your cart!</p>
              <a href="./drones.html" class="inline-block px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                Browse Drones
              </a>
            </div>
          `;
          return;
        }

        try {
          // Get all drones data
          const dronesData = await fetchJson(DRONES_API + "?action=list");
          const drones = dronesData.drones || [];
          const dronesMap = {};
          drones.forEach((d) => {
            dronesMap[d.id_drone] = d;
          });

          let total = 0;
          const cartItems = [];

          // Build cart items
          for (const [droneId, item] of Object.entries(cart)) {
            const drone = dronesMap[droneId];
            if (drone) {
              const quantity = item.quantity || 1;
              const subtotal = drone.price * quantity;
              total += subtotal;
              cartItems.push({
                drone,
                quantity,
                subtotal,
              });
            }
          }

          if (cartItems.length === 0) {
            localStorage.removeItem("skysail_cart");
            loadCart();
            return;
          }

          cartContent.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
              <div class="p-6">
                <form id="cart-form" class="space-y-4">
                  ${cartItems
                    .map(
                      (item, index) => `
                    <div class="flex items-center gap-6 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                      <img
                        src="${imageUrlFromPath(item.drone.image)}"
                        alt="${item.drone.name}"
                        class="w-24 h-24 object-cover rounded-lg"
                        onerror="this.src='./images/drone.png'"
                      />
                      <div class="flex-1">
                        <h3 class="text-lg font-bold text-gray-900">${item.drone.name}</h3>
                        <p class="text-sm text-gray-600">${item.drone.brand || ""} • ${item.drone.type}</p>
                        <p class="text-purple-600 font-semibold mt-2">${formatMoney(item.drone.price)} per day</p>
                      </div>
                      <div class="flex items-center gap-4">
                        <input
                          type="number"
                          name="quantities[${item.drone.id_drone}]"
                          value="${item.quantity}"
                          min="1"
                          max="${item.drone.stock}"
                          class="w-20 rounded-lg border-gray-300 focus:border-purple-500 focus:ring-purple-500"
                        />
                        <p class="text-gray-600">× ${formatMoney(item.drone.price)}</p>
                      </div>
                      <div class="text-right">
                        <p class="text-xl font-bold text-gray-900">${formatMoney(item.subtotal)}</p>
                        <button
                          type="button"
                          class="text-red-600 hover:text-red-800 text-sm font-medium remove-item"
                          data-id="${item.drone.id_drone}"
                        >
                          Remove
                        </button>
                      </div>
                    </div>
                  `
                    )
                    .join("")}
                  <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <div class="flex gap-3">
                      <button
                        type="button"
                        id="clear-cart"
                        class="px-6 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition"
                      >
                        Clear Cart
                      </button>
                      <button
                        type="submit"
                        id="update-cart"
                        class="px-6 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition"
                      >
                        Update Quantities
                      </button>
                    </div>
                    <div class="text-right">
                      <p class="text-2xl font-bold text-gray-900">Total: ${formatMoney(total)}</p>
                    </div>
                  </div>
                  <div class="mt-6">
                    <a
                      href="./checkout.html"
                      id="proceed-checkout"
                      class="block w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold text-center hover:from-purple-700 hover:to-pink-700 transition-all duration-300 transform hover:scale-105 shadow-lg"
                    >
                      Proceed to Checkout
                    </a>
                  </div>
                </form>
              </div>
            </div>
          `;

          // Add event listeners
          document.querySelectorAll(".remove-item").forEach((btn) => {
            btn.addEventListener("click", () => {
              const droneId = btn.dataset.id;
              const cart = JSON.parse(localStorage.getItem("skysail_cart") || "{}");
              delete cart[droneId];
              localStorage.setItem("skysail_cart", JSON.stringify(cart));
              loadCart();
            });
          });

          document.getElementById("clear-cart").addEventListener("click", () => {
            if (confirm("Are you sure you want to clear your cart?")) {
              localStorage.removeItem("skysail_cart");
              loadCart();
            }
          });

          document.getElementById("cart-form").addEventListener("submit", (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const quantities = {};
            formData.forEach((value, key) => {
              if (key.startsWith("quantities[")) {
                const droneId = key.match(/\[(\d+)\]/)[1];
                const input = e.target.querySelector(`input[name="quantities[${droneId}]"]`);
                let qty = parseInt(value) || 1;
                const maxStock = input ? parseInt(input.getAttribute("max")) || Infinity : Infinity;
                if (qty > maxStock) {
                  qty = maxStock;
                }
                quantities[droneId] = qty;
              }
            });

            // Update cart (clamped to available stock)
            const cart = JSON.parse(localStorage.getItem("skysail_cart") || "{}");
            Object.keys(quantities).forEach((droneId) => {
              if (cart[droneId]) {
                cart[droneId].quantity = quantities[droneId];
              }
            });
            localStorage.setItem("skysail_cart", JSON.stringify(cart));
            loadCart();
            alert("Cart updated!");
          });

          const proceedBtn = document.getElementById("proceed-checkout");
          if (proceedBtn) {
            proceedBtn.addEventListener("click", (e) => {
              const form = document.getElementById("cart-form");
              if (!form) return;

              const inputs = form.querySelectorAll('input[name^="quantities["]');
              const problems = [];

              inputs.forEach((input) => {
                const qty = parseInt(input.value) || 1;
                const maxStock = parseInt(input.getAttribute("max")) || Infinity;
                if (qty > maxStock) {
                  const card = input.closest(".flex.items-center");
                  const nameEl = card ? card.querySelector("h3") : null;
                  const name = nameEl ? nameEl.textContent.trim() : "Drone";
                  problems.push(`${name} - requested ${qty}, only ${maxStock} in stock`);
                }
              });

              if (problems.length > 0) {
                e.preventDefault();
                alert(
                  "Cannot proceed to checkout because some items exceed available stock:\\n\\n" +
                    problems.join("\\n") +
                    "\\n\\nPlease reduce the quantities and update your cart first."
                );
              }
            });
          }
        } catch (err) {
          console.error(err);
          cartContent.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg p-12 text-center">
              <p class="text-red-500">Failed to load cart.</p>
            </div>
          `;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const user = getCurrentUser();
        if (user) {
          const userLabel = document.getElementById("user-label");
          if (userLabel) {
            userLabel.textContent = `${user.first_name || user.FirstName || ""} ${user.last_name || user.LastName || ""}`;
          }
        }

        loadCart();
      });
    </script>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav md:hidden">
      <div class="flex justify-around items-center">
        <a href="./client-dashboard.html" class="mobile-nav-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
          </svg>
          <span>Home</span>
        </a>
        <a href="./drones.html" class="mobile-nav-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
          <span>Drones</span>
        </a>
        <a href="./cart.html" class="mobile-nav-item active relative">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
          </svg>
          <span>Cart</span>
          <span id="mobile-cart-count" class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center hidden">0</span>
        </a>
        <a href="./bookings.html" class="mobile-nav-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          <span>Bookings</span>
        </a>
        <a href="./profile.html" class="mobile-nav-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          <span>Profile</span>
        </a>
      </div>
    </nav>
  </body>
</html>

