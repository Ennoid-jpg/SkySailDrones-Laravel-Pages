<?php
// api-password-reset.php
//
// Password reset API for GitHub Pages.
// Handles password reset requests and token-based password resets.
// Uses the same database as your Laravel app and applies basic CORS for ennoid-jpg.github.io

// Enable error reporting for debugging (remove in production)
error_reporting(E_ALL);
ini_set('display_errors', 0);

// === CONFIG ===
// GitHub Pages URL - Update this to match your actual GitHub Pages URL
// To find your GitHub Pages URL:
// 1. Go to your GitHub repository
// 2. Click Settings → Pages
// 3. Your site will be published at: https://username.github.io or https://username.github.io/repository-name
// 4. Update $githubPagesUrl below with your actual URL
$githubOrigin = 'https://ennoid-jpg.github.io';
$githubPagesUrl = 'https://ennoid-jpg.github.io'; // ⚠️ UPDATE THIS with your actual GitHub Pages URL

// Copy these from your .env on Hostinger (DB_HOST, DB_DATABASE, DB_USERNAME, DB_PASSWORD)
$dbHost = 'localhost';
$dbName = 'u921114123_skysail';
$dbUser = 'u921114123_fabro';
$dbPass = 'Dionnelouis123!';

// === EMAIL CONFIG (SMTP) ===
// You can set these directly here, or they will be read from .env file
// If you set them here, they will override .env values
$smtpConfig = [
    'host' => '', // e.g., 'smtp.gmail.com' or 'smtp.mailtrap.io'
    'port' => '', // e.g., 587 for TLS, 465 for SSL, 2525 for Mailtrap
    'encryption' => '', // 'tls' or 'ssl'
    'username' => '', // Your SMTP username/email
    'password' => '', // Your SMTP password or app password
    'from_address' => '', // e.g., 'noreply@skysaildrone.solof.shop'
    'from_name' => 'SkySail Drones',
];

// === CORS HEADERS (must be set before any output) ===
header('Access-Control-Allow-Origin: ' . $githubOrigin);
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, X-Requested-With');
header('Access-Control-Allow-Credentials: true');

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(204);
    exit;
}

header('Content-Type: application/json');

// === HELPERS ===
function respond($data, $status = 200)
{
    http_response_code($status);
    echo json_encode($data);
    exit;
}

// Basic error handler
set_exception_handler(function ($e) {
    respond([
        'success' => false,
        'message' => 'Server error: ' . $e->getMessage(),
    ], 500);
});

// === CONNECT TO DB ===
try {
    $dsn = "mysql:host=$dbHost;dbname=$dbName;charset=utf8mb4";
    $pdo = new PDO($dsn, $dbUser, $dbPass, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
    ]);
} catch (PDOException $e) {
    respond([
        'success' => false,
        'message' => 'Database connection failed: ' . $e->getMessage(),
    ], 500);
}

// === HELPER: Ensure password_reset_tokens table structure ===
function ensurePasswordResetTable($pdo) {
    // Check if table exists
    $checkTable = $pdo->query("SHOW TABLES LIKE 'password_reset_tokens'");
    if ($checkTable->rowCount() === 0) {
        // Create table
        $pdo->exec("
            CREATE TABLE password_reset_tokens (
                email VARCHAR(255) PRIMARY KEY,
                token VARCHAR(255) NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                expires_at DATETIME NOT NULL
            )
        ");
    } else {
        // Check if expires_at column exists
        $columns = $pdo->query("SHOW COLUMNS FROM password_reset_tokens")->fetchAll(PDO::FETCH_COLUMN);
        if (!in_array('expires_at', $columns)) {
            $pdo->exec("ALTER TABLE password_reset_tokens ADD COLUMN expires_at DATETIME NOT NULL");
        }
    }
}

// === HELPER: Send password reset email using SMTP ===
function sendPasswordResetEmail($toEmail, $toName, $resetUrl) {
    global $smtpConfig;
    
    // SMTP Configuration - Read from config array, .env, or environment variables
    $smtpHost = $smtpConfig['host'] ?: getenv('MAIL_HOST') ?: '';
    $smtpPort = $smtpConfig['port'] ?: getenv('MAIL_PORT') ?: '';
    $smtpEncryption = $smtpConfig['encryption'] ?: getenv('MAIL_ENCRYPTION') ?: 'tls';
    $smtpUsername = $smtpConfig['username'] ?: getenv('MAIL_USERNAME') ?: '';
    $smtpPassword = $smtpConfig['password'] ?: getenv('MAIL_PASSWORD') ?: '';
    $fromEmail = $smtpConfig['from_address'] ?: getenv('MAIL_FROM_ADDRESS') ?: 'noreply@skysaildrone.solof.shop';
    $fromName = $smtpConfig['from_name'] ?: getenv('MAIL_FROM_NAME') ?: 'SkySail Drones';
    
    // Try to read from .env file if it exists (Laravel .env file)
    $envFile = __DIR__ . '/../../.env';
    if (file_exists($envFile)) {
        $envContent = file_get_contents($envFile);
        $lines = explode("\n", $envContent);
        foreach ($lines as $line) {
            $line = trim($line);
            if (empty($line) || strpos($line, '#') === 0) continue;
            if (strpos($line, '=') === false) continue;
            list($key, $value) = explode('=', $line, 2);
            $key = trim($key);
            $value = trim($value);
            // Remove quotes if present
            $value = trim($value, '"\'');
            
            if (empty($smtpHost) && $key === 'MAIL_HOST') $smtpHost = $value;
            if (empty($smtpPort) && $key === 'MAIL_PORT') $smtpPort = $value;
            if (empty($smtpEncryption) && $key === 'MAIL_ENCRYPTION') $smtpEncryption = $value;
            if (empty($smtpUsername) && $key === 'MAIL_USERNAME') $smtpUsername = $value;
            if (empty($smtpPassword) && $key === 'MAIL_PASSWORD') $smtpPassword = $value;
            if (empty($fromEmail) && $key === 'MAIL_FROM_ADDRESS') $fromEmail = $value;
            if ($key === 'MAIL_FROM_NAME') $fromName = $value;
        }
    }
    
    // Set defaults if still empty
    if (empty($smtpHost)) $smtpHost = 'smtp.gmail.com';
    if (empty($smtpPort)) $smtpPort = 587;
    if (empty($smtpEncryption)) $smtpEncryption = 'tls';
    if (empty($fromEmail)) $fromEmail = 'noreply@skysaildrone.solof.shop';
    if (empty($fromName)) $fromName = 'SkySail Drones';
    
    // If no SMTP credentials, fall back to mail()
    if (empty($smtpUsername) || empty($smtpPassword)) {
        return sendPasswordResetEmailFallback($toEmail, $toName, $resetUrl, $fromEmail, $fromName);
    }
    
    $subject = 'SkySail Drones - Password Reset Request';
    
    $message = "
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset='UTF-8'>
        <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
            .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 8px 8px; }
            .button { display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
            .footer { text-align: center; margin-top: 20px; color: #666; font-size: 12px; }
        </style>
    </head>
    <body>
        <div class='container'>
            <div class='header'>
                <h1>SkySail Drones</h1>
            </div>
            <div class='content'>
                <h2>Password Reset Request</h2>
                <p>Hello " . htmlspecialchars($toName) . ",</p>
                <p>We received a request to reset your password for your SkySail Drones account.</p>
                <p>Click the button below to reset your password:</p>
                <p style='text-align: center;'>
                    <a href='" . htmlspecialchars($resetUrl) . "' class='button'>Reset Password</a>
                </p>
                <p>Or copy and paste this link into your browser:</p>
                <p style='word-break: break-all; color: #667eea;'>" . htmlspecialchars($resetUrl) . "</p>
                <p><strong>This link will expire in 1 hour.</strong></p>
                <p>If you did not request a password reset, please ignore this email. Your password will remain unchanged.</p>
                <p>Best regards,<br>SkySail Drones Team</p>
            </div>
            <div class='footer'>
                <p>This is an automated message. Please do not reply to this email.</p>
            </div>
        </div>
    </body>
    </html>
    ";
    
    // Use PHPMailer if available, otherwise use simple SMTP
    if (class_exists('PHPMailer\\PHPMailer\\PHPMailer')) {
        return sendPasswordResetEmailPHPMailer($toEmail, $toName, $resetUrl, $subject, $message, $smtpHost, $smtpPort, $smtpEncryption, $smtpUsername, $smtpPassword, $fromEmail, $fromName);
    } else {
        return sendPasswordResetEmailSMTP($toEmail, $toName, $resetUrl, $subject, $message, $smtpHost, $smtpPort, $smtpEncryption, $smtpUsername, $smtpPassword, $fromEmail, $fromName);
    }
}

// === HELPER: Send email using simple SMTP ===
function sendPasswordResetEmailSMTP($toEmail, $toName, $resetUrl, $subject, $message, $host, $port, $encryption, $username, $password, $fromEmail, $fromName) {
    try {
        // Create socket connection
        $socket = @fsockopen(
            ($encryption === 'ssl' ? 'ssl://' : '') . $host,
            $port,
            $errno,
            $errstr,
            30
        );
        
        if (!$socket) {
            error_log("SMTP Connection failed: $errstr ($errno)");
            return false;
        }
        
        // Read server greeting
        $response = fgets($socket, 515);
        if (substr($response, 0, 3) != '220') {
            fclose($socket);
            return false;
        }
        
        // Send EHLO
        fputs($socket, "EHLO " . $host . "\r\n");
        $response = fgets($socket, 515);
        
        // Start TLS if needed
        if ($encryption === 'tls') {
            fputs($socket, "STARTTLS\r\n");
            $response = fgets($socket, 515);
            if (substr($response, 0, 3) != '220') {
                fclose($socket);
                return false;
            }
            stream_socket_enable_crypto($socket, true, STREAM_CRYPTO_METHOD_TLS_CLIENT);
            fputs($socket, "EHLO " . $host . "\r\n");
            $response = fgets($socket, 515);
        }
        
        // Authenticate
        fputs($socket, "AUTH LOGIN\r\n");
        $response = fgets($socket, 515);
        fputs($socket, base64_encode($username) . "\r\n");
        $response = fgets($socket, 515);
        fputs($socket, base64_encode($password) . "\r\n");
        $response = fgets($socket, 515);
        if (substr($response, 0, 3) != '235') {
            fclose($socket);
            return false;
        }
        
        // Send email
        fputs($socket, "MAIL FROM: <$fromEmail>\r\n");
        $response = fgets($socket, 515);
        fputs($socket, "RCPT TO: <$toEmail>\r\n");
        $response = fgets($socket, 515);
        fputs($socket, "DATA\r\n");
        $response = fgets($socket, 515);
        
        // Email headers and body
        $emailData = "From: $fromName <$fromEmail>\r\n";
        $emailData .= "To: $toName <$toEmail>\r\n";
        $emailData .= "Subject: $subject\r\n";
        $emailData .= "MIME-Version: 1.0\r\n";
        $emailData .= "Content-Type: text/html; charset=UTF-8\r\n";
        $emailData .= "\r\n";
        $emailData .= $message . "\r\n";
        $emailData .= ".\r\n";
        
        fputs($socket, $emailData);
        $response = fgets($socket, 515);
        
        fputs($socket, "QUIT\r\n");
        fclose($socket);
        
        return substr($response, 0, 3) == '250';
    } catch (Exception $e) {
        error_log("SMTP Error: " . $e->getMessage());
        return false;
    }
}

// === HELPER: Fallback to mail() function ===
function sendPasswordResetEmailFallback($toEmail, $toName, $resetUrl, $fromEmail, $fromName) {
    $subject = 'SkySail Drones - Password Reset Request';
    
    $message = "
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset='UTF-8'>
        <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
            .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 8px 8px; }
            .button { display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
            .footer { text-align: center; margin-top: 20px; color: #666; font-size: 12px; }
        </style>
    </head>
    <body>
        <div class='container'>
            <div class='header'>
                <h1>SkySail Drones</h1>
            </div>
            <div class='content'>
                <h2>Password Reset Request</h2>
                <p>Hello " . htmlspecialchars($toName) . ",</p>
                <p>We received a request to reset your password for your SkySail Drones account.</p>
                <p>Click the button below to reset your password:</p>
                <p style='text-align: center;'>
                    <a href='" . htmlspecialchars($resetUrl) . "' class='button'>Reset Password</a>
                </p>
                <p>Or copy and paste this link into your browser:</p>
                <p style='word-break: break-all; color: #667eea;'>" . htmlspecialchars($resetUrl) . "</p>
                <p><strong>This link will expire in 1 hour.</strong></p>
                <p>If you did not request a password reset, please ignore this email. Your password will remain unchanged.</p>
                <p>Best regards,<br>SkySail Drones Team</p>
            </div>
            <div class='footer'>
                <p>This is an automated message. Please do not reply to this email.</p>
            </div>
        </div>
    </body>
    </html>
    ";
    
    $headers = "MIME-Version: 1.0" . "\r\n";
    $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
    $headers .= "From: $fromName <$fromEmail>" . "\r\n";
    $headers .= "Reply-To: $fromEmail" . "\r\n";
    $headers .= "X-Mailer: PHP/" . phpversion();
    
    return mail($toEmail, $subject, $message, $headers);
}

// === HELPER: Send email using PHPMailer (if available) ===
function sendPasswordResetEmailPHPMailer($toEmail, $toName, $resetUrl, $subject, $message, $host, $port, $encryption, $username, $password, $fromEmail, $fromName) {
    try {
        $mail = new \PHPMailer\PHPMailer\PHPMailer(true);
        $mail->isSMTP();
        $mail->Host = $host;
        $mail->SMTPAuth = true;
        $mail->Username = $username;
        $mail->Password = $password;
        $mail->SMTPSecure = $encryption;
        $mail->Port = $port;
        $mail->CharSet = 'UTF-8';
        
        $mail->setFrom($fromEmail, $fromName);
        $mail->addAddress($toEmail, $toName);
        $mail->isHTML(true);
        $mail->Subject = $subject;
        $mail->Body = $message;
        
        return $mail->send();
    } catch (Exception $e) {
        error_log("PHPMailer Error: " . $mail->ErrorInfo);
        return false;
    }
}

// === ROUTING ===
$method = $_SERVER['REQUEST_METHOD'];
$action = $_GET['action'] ?? $_POST['action'] ?? '';

// --- REQUEST PASSWORD RESET (POST) ---
if ($method === 'POST' && $action === 'request') {
    $username = trim($_POST['username'] ?? '');

    if ($username === '') {
        respond([
            'success' => false,
            'message' => 'Username (email) is required.',
        ], 422);
    }

    // Find user by username or email
    $stmt = $pdo->prepare("SELECT id_user, FirstName, LastName, username FROM users WHERE username = :username OR email = :username");
    $stmt->execute([':username' => $username]);
    $user = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$user) {
        respond([
            'success' => false,
            'message' => 'We couldn\'t find an account with that email.',
        ], 404);
    }

    // Generate reset token (simple approach: use timestamp + random string)
    $token = bin2hex(random_bytes(32));
    $expiresAt = date('Y-m-d H:i:s', strtotime('+1 hour'));

    // Ensure table structure is correct
    ensurePasswordResetTable($pdo);

    // Delete old tokens for this user
    $deleteStmt = $pdo->prepare("DELETE FROM password_reset_tokens WHERE email = :email");
    $deleteStmt->execute([':email' => $user['username']]);

    // Insert new token
    $insertStmt = $pdo->prepare("
        INSERT INTO password_reset_tokens (email, token, expires_at)
        VALUES (:email, :token, :expires_at)
        ON DUPLICATE KEY UPDATE token = :token, expires_at = :expires_at, created_at = CURRENT_TIMESTAMP
    ");
    $insertStmt->execute([
        ':email' => $user['username'],
        ':token' => password_hash($token, PASSWORD_BCRYPT),
        ':expires_at' => $expiresAt,
    ]);

    // Generate reset URL
    global $githubPagesUrl;
    $resetUrl = rtrim($githubPagesUrl, '/') . '/reset-password.html?token=' . urlencode($token) . '&email=' . urlencode($user['username']);
    
    // Get user's email address (prefer email column, fallback to username)
    $userEmail = $user['username']; // Use username as email (since username stores email)
    $userName = trim(($user['FirstName'] ?? '') . ' ' . ($user['LastName'] ?? ''));
    if (empty($userName)) {
        $userName = $userEmail;
    }
    
    // Send password reset email
    $emailSent = sendPasswordResetEmail($userEmail, $userName, $resetUrl);
    
    // Always return success (don't reveal if email was sent or not for security)
    // Even if email fails, we don't want to reveal that the user exists
    respond([
        'success' => true,
        'message' => 'If an account exists with that email, we have sent a password reset link.',
    ]);
}

// --- VERIFY TOKEN (GET) ---
if ($method === 'GET' && $action === 'verify') {
    $token = $_GET['token'] ?? '';
    $email = $_GET['email'] ?? '';

    if ($token === '' || $email === '') {
        respond([
            'success' => false,
            'message' => 'Token and email are required.',
        ], 422);
    }

    // Ensure table structure is correct
    ensurePasswordResetTable($pdo);

    // Get token from database
    $stmt = $pdo->prepare("SELECT token, expires_at FROM password_reset_tokens WHERE email = :email");
    $stmt->execute([':email' => $email]);
    $tokenData = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$tokenData) {
        respond([
            'success' => false,
            'message' => 'Invalid or expired reset token.',
        ], 404);
    }

    // Check if token is expired
    if (strtotime($tokenData['expires_at']) < time()) {
        respond([
            'success' => false,
            'message' => 'Reset token has expired. Please request a new one.',
        ], 422);
    }

    // Verify token
    if (!password_verify($token, $tokenData['token'])) {
        respond([
            'success' => false,
            'message' => 'Invalid reset token.',
        ], 422);
    }

    respond([
        'success' => true,
        'message' => 'Token is valid.',
    ]);
}

// --- RESET PASSWORD (POST) ---
if ($method === 'POST' && $action === 'reset') {
    $token = trim($_POST['token'] ?? '');
    $email = trim($_POST['email'] ?? '');
    $password = $_POST['password'] ?? '';
    $password_confirmation = $_POST['password_confirmation'] ?? '';

    if ($token === '' || $email === '' || $password === '') {
        respond([
            'success' => false,
            'message' => 'Token, email, and password are required.',
        ], 422);
    }

    if ($password !== $password_confirmation) {
        respond([
            'success' => false,
            'message' => 'Password and confirmation do not match.',
        ], 422);
    }

    if (strlen($password) < 8) {
        respond([
            'success' => false,
            'message' => 'Password must be at least 8 characters.',
        ], 422);
    }

    // Ensure table structure is correct
    ensurePasswordResetTable($pdo);

    // Get and verify token
    $stmt = $pdo->prepare("SELECT token, expires_at FROM password_reset_tokens WHERE email = :email");
    $stmt->execute([':email' => $email]);
    $tokenData = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$tokenData) {
        respond([
            'success' => false,
            'message' => 'Invalid or expired reset token.',
        ], 404);
    }

    // Check if token is expired
    if (strtotime($tokenData['expires_at']) < time()) {
        respond([
            'success' => false,
            'message' => 'Reset token has expired. Please request a new one.',
        ], 422);
    }

    // Verify token
    if (!password_verify($token, $tokenData['token'])) {
        respond([
            'success' => false,
            'message' => 'Invalid reset token.',
        ], 422);
    }

    // Find user
    $userStmt = $pdo->prepare("SELECT id_user FROM users WHERE username = :email OR email = :email");
    $userStmt->execute([':email' => $email]);
    $user = $userStmt->fetch(PDO::FETCH_ASSOC);

    if (!$user) {
        respond([
            'success' => false,
            'message' => 'User not found.',
        ], 404);
    }

    // Update password
    $hashedPassword = password_hash($password, PASSWORD_BCRYPT);
    $updateStmt = $pdo->prepare("UPDATE users SET Password = :password WHERE id_user = :id");
    $updateStmt->execute([
        ':password' => $hashedPassword,
        ':id' => $user['id_user'],
    ]);

    // Delete used token
    $deleteStmt = $pdo->prepare("DELETE FROM password_reset_tokens WHERE email = :email");
    $deleteStmt->execute([':email' => $email]);

    respond([
        'success' => true,
        'message' => 'Password has been reset successfully. You can now log in with your new password.',
    ]);
}

// --- TEST ENDPOINT (GET) ---
if ($method === 'GET' && $action === 'test') {
    respond([
        'success' => true,
        'message' => 'Password reset API is working!',
        'timestamp' => date('Y-m-d H:i:s'),
    ]);
}

// --- FALLBACK ---
respond([
    'success' => false,
    'message' => 'Unknown action or method.',
], 400);

