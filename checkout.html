<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SkySail Drones - Checkout</title>
    <link rel="icon" href="./images/image-removebg-preview 2.png" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Montserrat", sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900 min-h-screen">
    <script src="./auth-role.js"></script>
    <script>
      // Require login for all user types - check after DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        const user = getCurrentUser();
        if (!user || (!user.id_user && !user.username)) {
          window.location.href = "./login.html";
          return;
        }
      });
    </script>

    <div class="min-h-screen flex flex-col">
      <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div class="flex items-center justify-between">
            <a href="./cart.html" class="flex items-center gap-2">
              <img src="./images/logolight.png" alt="SkySail Logo" class="h-10 w-auto" />
            </a>
            <div class="flex items-center gap-4 text-sm">
              <a
                href="./cart.html"
                class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium text-sm transition"
              >
                ← Back to Cart
              </a>
              <span id="user-label" class="text-gray-600"></span>
              <button
                onclick="logoutAndRedirect('./login.html')"
                class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium text-sm transition"
              >
                Logout
              </button>
            </div>
          </div>
        </div>
      </header>

      <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Checkout</h2>

        <div class="grid md:grid-cols-3 gap-8">
          <!-- Order Summary -->
          <div class="md:col-span-2">
            <div class="bg-white rounded-xl shadow-lg p-8">
              <h3 class="text-2xl font-bold text-gray-900 mb-6">Order Summary</h3>
              <div id="order-summary" class="space-y-4">
                <div class="text-center text-gray-500 py-8">Loading order summary...</div>
              </div>
              <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex justify-between items-center">
                  <span class="text-xl font-bold text-gray-900">Total</span>
                  <span id="order-total" class="text-2xl font-bold text-purple-600"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Checkout Form -->
          <div class="md:col-span-1">
            <div class="bg-white rounded-xl shadow-lg p-8">
              <h3 class="text-2xl font-bold text-gray-900 mb-6">Checkout</h3>
              <form id="checkout-form" class="space-y-6">
                <div>
                  <label for="return_date" class="block text-sm font-medium text-gray-700 mb-2">
                    Return Date <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="date"
                    id="return_date"
                    name="return_date"
                    required
                    class="w-full rounded-lg border-gray-300 focus:border-purple-500 focus:ring-purple-500"
                  />
                </div>

                <div>
                  <label for="return_time" class="block text-sm font-medium text-gray-700 mb-2">
                    Return Time <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="time"
                    id="return_time"
                    name="return_time"
                    required
                    class="w-full rounded-lg border-gray-300 focus:border-purple-500 focus:ring-purple-500"
                  />
                </div>

                <div class="pt-4 border-t border-gray-200">
                  <h4 class="font-semibold text-gray-900 mb-4">Payment Information</h4>

                  <div class="mb-4">
                    <label for="card_number" class="block text-sm font-medium text-gray-700 mb-2">
                      Card Number <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      id="card_number"
                      name="card_number"
                      maxlength="16"
                      pattern="[0-9]{16}"
                      required
                      placeholder="1234 5678 9012 3456"
                      class="w-full rounded-lg border-gray-300 focus:border-purple-500 focus:ring-purple-500"
                    />
                  </div>

                  <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                      <label for="expiration_date" class="block text-sm font-medium text-gray-700 mb-2">
                        Expiration <span class="text-red-500">*</span>
                      </label>
                      <input
                        type="month"
                        id="expiration_date"
                        name="expiration_date"
                        required
                        class="w-full rounded-lg border-gray-300 focus:border-purple-500 focus:ring-purple-500"
                      />
                    </div>
                    <div>
                      <label for="cvv" class="block text-sm font-medium text-gray-700 mb-2">
                        CVV <span class="text-red-500">*</span>
                      </label>
                      <input
                        type="password"
                        id="cvv"
                        name="cvv"
                        maxlength="3"
                        pattern="[0-9]{3}"
                        required
                        placeholder="123"
                        class="w-full rounded-lg border-gray-300 focus:border-purple-500 focus:ring-purple-500"
                      />
                    </div>
                  </div>
                </div>

                <button
                  type="submit"
                  class="w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition-all duration-300 transform hover:scale-105 shadow-lg"
                >
                  Complete Booking
                </button>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      const API_BASE = "https://skysaildrone.solof.shop";
      const DRONES_API = API_BASE + "/api-drones.php";
      const BOOKINGS_API = API_BASE + "/api-bookings.php";

      function formatMoney(value) {
        const num = Number(value || 0);
        return "₱" + num.toLocaleString("en-PH", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function imageUrlFromPath(path) {
        if (!path) return "./images/drone.png";
        if (path.startsWith("http")) return path;
        if (path.startsWith("drones/")) {
          const fileName = path.split("/").pop();
          return "./drone-images/" + fileName;
        }
        if (path.startsWith("storage/app/public/drones/")) {
          const fileName = path.split("/").pop();
          return API_BASE + "/storage/" + fileName;
        }
        return "./images/drone.png";
      }

      async function fetchJson(url, options = {}) {
        const res = await fetch(url, options);
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
          throw new Error(data.message || "Request failed");
        }
        return data;
      }

      async function loadOrderSummary() {
        const cart = JSON.parse(localStorage.getItem("skysail_cart") || "{}");

        if (Object.keys(cart).length === 0) {
          alert("Your cart is empty. Redirecting to drones page...");
          window.location.href = "./drones.html";
          return;
        }

        try {
          const dronesData = await fetchJson(DRONES_API + "?action=list");
          const drones = dronesData.drones || [];
          const dronesMap = {};
          drones.forEach((d) => {
            dronesMap[d.id_drone] = d;
          });

          let total = 0;
          const cartItems = [];

          for (const [droneId, item] of Object.entries(cart)) {
            const drone = dronesMap[droneId];
            if (drone) {
              const quantity = item.quantity || 1;
              const subtotal = drone.price * quantity;
              total += subtotal;
              cartItems.push({
                drone,
                quantity,
                subtotal,
              });
            }
          }

          const summaryEl = document.getElementById("order-summary");
          summaryEl.innerHTML = cartItems
            .map(
              (item) => `
            <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
              <img
                src="${imageUrlFromPath(item.drone.image)}"
                alt="${item.drone.name}"
                class="w-16 h-16 object-cover rounded-lg"
                onerror="this.src='./images/drone.png'"
              />
              <div class="flex-1">
                <p class="font-semibold text-gray-900">${item.drone.name}</p>
                <p class="text-sm text-gray-600">Quantity: ${item.quantity}</p>
              </div>
              <p class="font-bold text-gray-900">${formatMoney(item.subtotal)}</p>
            </div>
          `
            )
            .join("");

          document.getElementById("order-total").textContent = formatMoney(total);

          // Set minimum date to tomorrow
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          document.getElementById("return_date").min = tomorrow.toISOString().split("T")[0];
        } catch (err) {
          console.error(err);
          alert("Failed to load order summary.");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const user = getCurrentUser();
        if (user) {
          const userLabel = document.getElementById("user-label");
          if (userLabel) {
            userLabel.textContent = `${user.first_name || user.FirstName || ""} ${user.last_name || user.LastName || ""}`;
          }
        }

        loadOrderSummary();

        document.getElementById("checkout-form").addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const cart = JSON.parse(localStorage.getItem("skysail_cart") || "{}");

          if (Object.keys(cart).length === 0) {
            alert("Your cart is empty.");
            return;
          }

          const user = getCurrentUser();
          if (!user || !user.id_user) {
            alert("Please log in to complete booking.");
            window.location.href = "./login.html";
            return;
          }

          // Build booking data
          const droneIds = Object.keys(cart);
          const quantities = Object.values(cart).map((item) => item.quantity || 1);

          const bookingData = new URLSearchParams();
          bookingData.append("action", "create");
          bookingData.append("id_user", user.id_user);
          droneIds.forEach((id) => bookingData.append("drone_ids[]", id));
          quantities.forEach((qty) => bookingData.append("quantities[]", qty));
          bookingData.append("return_date", formData.get("return_date"));
          bookingData.append("return_time", formData.get("return_time"));
          bookingData.append("payment_type", "Credit Card");
          bookingData.append("card_number", formData.get("card_number"));
          bookingData.append("expiration_date", formData.get("expiration_date"));
          bookingData.append("cvv", formData.get("cvv"));

          try {
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = "Processing...";

            await fetchJson(BOOKINGS_API, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: bookingData.toString(),
            });

            // Clear cart
            localStorage.removeItem("skysail_cart");

            alert("Booking created successfully!");
            window.location.href = "./client-dashboard.html";
          } catch (err) {
            alert("Failed to create booking: " + err.message);
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.textContent = "Complete Booking";
          }
        });
      });
    </script>
  </body>
</html>

