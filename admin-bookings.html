<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SkySail Drones - Admin Bookings</title>
    <link rel="icon" href="./images/image-removebg-preview 2.png" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Montserrat", sans-serif;
      }
    </style>
  </head>
  <body class="bg-slate-950 text-slate-50 min-h-screen">
    <script src="./auth-role.js"></script>
    <script>
      requireRole("admin", {
        loginPath: "./login.html",
        forbiddenPath: "./index.html",
      });
    </script>

    <div class="min-h-screen flex flex-col">
      <header
        class="flex items-center justify-between px-6 py-4 bg-slate-900/80 border-b border-slate-800"
      >
        <a href="./admin-dashboard.html" class="flex items-center gap-2">
          <img src="./images/logolight.png" alt="SkySail Logo" class="h-10 w-auto" />
        </a>
        <div class="flex items-center gap-4 text-sm">
          <span id="admin-user-label" class="text-slate-300"></span>
          <button
            onclick="logoutAndRedirect('./login.html')"
            class="px-3 py-1.5 rounded-md bg-red-500/90 hover:bg-red-500 text-white font-medium text-xs transition"
          >
            Logout
          </button>
        </div>
      </header>

      <main class="flex-1 px-4 sm:px-6 lg:px-10 py-8 space-y-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h1 class="text-3xl font-semibold">Bookings Management</h1>
            <p class="text-slate-300 text-sm">
              View, filter, update status, and delete bookings via the API.
            </p>
          </div>
        </div>

        <!-- Search / Filter -->
        <section class="bg-slate-900/70 border border-slate-800 rounded-xl p-4">
          <form
            id="filter-form"
            class="flex flex-col gap-3 md:flex-row md:items-center md:gap-4"
          >
            <div class="flex-1">
              <input
                id="search-input"
                type="text"
                placeholder="Search by customer name or email..."
                class="w-full rounded-md border border-slate-700 bg-slate-950/40 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-purple-500"
              />
            </div>
            <div class="w-full md:w-48">
              <select
                id="sort-status"
                class="w-full rounded-md border border-slate-700 bg-slate-950/40 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-purple-500"
              >
                <option value="workflow">Sort by Status</option>
                <option value="Pending">Pending</option>
                <option value="Accepted">Accepted</option>
                <option value="Returned">Returned</option>
                <option value="Returned Damaged">Returned Damaged</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <button
              type="submit"
              class="px-4 py-2 rounded-md bg-purple-600 hover:bg-purple-700 text-xs font-medium"
            >
              Search
            </button>
            <button
              type="button"
              id="clear-filters"
              class="px-3 py-2 rounded-md bg-slate-800 hover:bg-slate-700 text-xs font-medium"
            >
              Clear
            </button>
          </form>
        </section>

        <!-- Bookings Table -->
        <section class="bg-slate-900/70 border border-slate-800 rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-800 text-sm" id="bookings-table">
              <thead class="bg-slate-900/90 text-slate-300 text-xs uppercase">
                <tr>
                  <th class="px-4 py-3 text-left">Customer</th>
                  <th class="px-4 py-3 text-left">Items</th>
                  <th class="px-4 py-3 text-left">Return</th>
                  <th class="px-4 py-3 text-left">Status</th>
                  <th class="px-4 py-3 text-left">Price</th>
                  <th class="px-4 py-3 text-left">Actions</th>
                </tr>
              </thead>
              <tbody id="bookings-tbody" class="divide-y divide-slate-800 bg-slate-950/40">
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-slate-400 text-sm">
                    Loading bookings...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <script>
      const API_BASE = "https://skysaildrone.solof.shop";
      const BOOKINGS_API = API_BASE + "/api-bookings.php";

      function formatMoney(value) {
        const num = Number(value || 0);
        return "₱" + num.toLocaleString("en-PH", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function formatDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        if (isNaN(d)) return dateStr;
        return d.toLocaleString("en-PH", {
          month: "short",
          day: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatItemsWithQuantities(booking) {
        if (!booking.item_names) {
          return booking.quantity ? `Drone Rental (x${booking.quantity})` : "Drone Rental";
        }

        const itemNames = booking.item_names.split(',').map(name => name.trim());
        const itemQuantities = booking.item_quantities 
          ? booking.item_quantities.split(',').map(qty => qty.trim())
          : [];

        if (itemQuantities.length === 0 || itemQuantities.length !== itemNames.length) {
          // Fallback: show total quantity if quantities don't match
          return booking.quantity 
            ? `${booking.item_names} (Total: ${booking.quantity})`
            : booking.item_names;
        }

        // Combine names with quantities: "ATOM SE (x1), ASTRO (x2)"
        return itemNames.map((name, index) => {
          const qty = itemQuantities[index] || '1';
          return `${name} (x${qty})`;
        }).join(', ');
      }

      function getStatusOptions(currentStatus) {
        const status = currentStatus || "Pending";
        
        // If already returned, only allow switching between Returned and Returned Damaged
        if (status === "Returned" || status === "Returned Damaged") {
          return `
            <option value="Returned" ${status === "Returned" ? "selected" : ""}>Returned</option>
            <option value="Returned Damaged" ${status === "Returned Damaged" ? "selected" : ""}>Returned Damaged</option>
          `;
        }
        
        // If accepted, remove Pending and Cancelled options
        if (status === "Accepted") {
          return `
            <option value="Accepted" selected>Accepted</option>
            <option value="Returned">Returned</option>
            <option value="Returned Damaged">Returned Damaged</option>
          `;
        }
        
        // If pending, only allow Accepted or Cancelled (cannot return items that haven't been accepted yet)
        if (status === "Pending") {
          return `
            <option value="Pending" selected>Pending</option>
            <option value="Accepted">Accepted</option>
            <option value="Cancelled">Cancelled</option>
          `;
        }
        
        // If cancelled, lock the status (no further changes)
        if (status === "Cancelled") {
          return `
            <option value="Cancelled" selected>Cancelled</option>
          `;
        }

        // Fallback: show current status as a single locked option
        return `
          <option value="${status}" selected>${status}</option>
        `;
      }

      function calculatePenalty(booking) {
        // Only calculate penalty for Accepted bookings that are overdue
        // Pending and Cancelled bookings never incur penalties
        if (booking.Status === "Returned" || booking.Status === "Returned Damaged" || booking.Status === "Cancelled" || booking.Status === "Pending") {
          return { penalty: 0, daysOverdue: 0 };
        }

        if (!booking.return_date) {
          return { penalty: 0, daysOverdue: 0 };
        }

        const returnDate = new Date(booking.return_date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        returnDate.setHours(0, 0, 0, 0);

        // Check if overdue
        if (returnDate >= today) {
          return { penalty: 0, daysOverdue: 0 };
        }

        // Calculate days overdue
        const daysOverdue = Math.floor((today - returnDate) / (1000 * 60 * 60 * 24));
        
        // Penalty: 10% of booking price per day overdue
        const penaltyRate = 0.1; // 10% per day
        const penalty = parseFloat(booking.price || 0) * penaltyRate * daysOverdue;

        return { penalty, daysOverdue };
      }

      async function fetchJson(url, options = {}) {
        const res = await fetch(url, options);
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
          throw new Error(data.message || "Request failed");
        }
        return data;
      }

      function sortBookings(bookings, selectedStatus) {
        const statusOrder = {
          "Pending": 1,
          "Accepted": 2,
          "Returned": 3,
          "Returned Damaged": 4,
          "Cancelled": 5
        };

        // If workflow order is selected or no status selected, use workflow order
        if (!selectedStatus || selectedStatus === "workflow") {
          const sorted = [...bookings];
          sorted.sort((a, b) => {
            const orderA = statusOrder[a.Status] || 99;
            const orderB = statusOrder[b.Status] || 99;
            if (orderA !== orderB) {
              return orderA - orderB;
            }
            // If same status, sort by date (newest first)
            const dateA = new Date(a.checkout_date || 0);
            const dateB = new Date(b.checkout_date || 0);
            return dateB - dateA;
          });
          return sorted;
        }

        // Filter and sort: selected status at top, then others in workflow order
        const selected = bookings.filter(b => b.Status === selectedStatus);
        const others = bookings.filter(b => b.Status !== selectedStatus);
        
        // Sort selected status by date (newest first)
        selected.sort((a, b) => {
          const dateA = new Date(a.checkout_date || 0);
          const dateB = new Date(b.checkout_date || 0);
          return dateB - dateA;
        });
        
        // Sort others by workflow order, then by date
        others.sort((a, b) => {
          const orderA = statusOrder[a.Status] || 99;
          const orderB = statusOrder[b.Status] || 99;
          if (orderA !== orderB) {
            return orderA - orderB;
          }
          const dateA = new Date(a.checkout_date || 0);
          const dateB = new Date(b.checkout_date || 0);
          return dateB - dateA;
        });

        // Return selected status first, then others in workflow order
        return [...selected, ...others];
      }

      async function loadBookings(params = {}) {
        const tbody = document.getElementById("bookings-tbody");
        tbody.innerHTML =
          '<tr><td colspan="6" class="px-4 py-6 text-center text-slate-400 text-sm">Loading bookings...</td></tr>';

        const query = new URLSearchParams({ action: "list", ...params });

        try {
          const data = await fetchJson(BOOKINGS_API + "?" + query.toString());
          let bookings = data.bookings || [];
          
          // Apply status sorting/filtering
          const selectedStatus = document.getElementById("sort-status")?.value || "";
          bookings = sortBookings(bookings, selectedStatus);

          if (bookings.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-400 text-sm">No bookings found.</td></tr>';
            return;
          }

          tbody.innerHTML = "";
          bookings.forEach((b) => {
            const penaltyInfo = calculatePenalty(b);
            const totalAmount = parseFloat(b.price || 0) + penaltyInfo.penalty;
            
            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-900/60 transition";

            const statusClasses =
              b.Status === "Accepted"
                ? "bg-emerald-500/15 text-emerald-300"
                : b.Status === "Pending"
                ? "bg-amber-500/15 text-amber-300"
                : b.Status === "Returned"
                ? "bg-sky-500/15 text-sky-300"
                : b.Status === "Returned Damaged"
                ? "bg-red-500/15 text-red-300"
                : "bg-slate-700/60 text-slate-200";

            tr.innerHTML = `
              <td class="px-4 py-3">
                <div class="font-medium text-sm">${b.FirstName} ${b.LastName}</div>
                <div class="text-xs text-slate-400">${b.username}</div>
              </td>
              <td class="px-4 py-3 text-xs">
                <div class="font-medium">${formatItemsWithQuantities(b)}</div>
                ${penaltyInfo.daysOverdue > 0 ? `<div class="text-red-400 font-semibold mt-1">⚠️ Overdue: ${penaltyInfo.daysOverdue} day${penaltyInfo.daysOverdue > 1 ? 's' : ''}</div>` : ''}
              </td>
              <td class="px-4 py-3 text-xs">
                <div>${b.return_date || ""} ${b.return_time || ""}</div>
                <div class="text-slate-400">${formatDate(b.checkout_date)}</div>
              </td>
              <td class="px-4 py-3 text-xs">
                <span class="inline-flex px-2 py-1 rounded-full text-[11px] font-semibold ${statusClasses}">
                  ${b.Status}
                </span>
              </td>
              <td class="px-4 py-3 text-sm">
                <div class="font-semibold text-purple-300">${formatMoney(b.price)}</div>
                ${penaltyInfo.penalty > 0 ? `<div class="text-red-400 text-xs">Penalty: ${formatMoney(penaltyInfo.penalty)}</div>` : ''}
                ${penaltyInfo.penalty > 0 ? `<div class="font-semibold text-purple-200 mt-1">Total: ${formatMoney(totalAmount)}</div>` : ''}
              </td>
              <td class="px-4 py-3 text-xs">
                <div class="flex flex-col gap-1">
                  <select
                    class="status-select w-full rounded-md border border-slate-700 bg-slate-950/60 px-2 py-1 text-[11px] focus:outline-none focus:ring-1 focus:ring-purple-500"
                    data-id="${b.id_booked}"
                  >
                    ${getStatusOptions(b.Status)}
                  </select>
                  <button
                    class="save-status px-2 py-1 rounded bg-purple-600 hover:bg-purple-700 text-[11px] font-medium"
                    data-id="${b.id_booked}"
                  >
                    Save
                  </button>
                </div>
              </td>
            `;

            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          tbody.innerHTML =
            '<tr><td colspan="6" class="px-4 py-8 text-center text-red-300 text-sm">Failed to load bookings.</td></tr>';
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const user = getCurrentUser();
        if (user) {
          const el = document.getElementById("admin-user-label");
          if (el) {
            el.textContent = `${user.first_name || ""} ${user.last_name || ""} (${user.email})`;
          }
        }

        loadBookings();

        document.getElementById("filter-form").addEventListener("submit", (e) => {
          e.preventDefault();
          const search = document.getElementById("search-input").value.trim();
          loadBookings({ search });
        });

        document.getElementById("clear-filters").addEventListener("click", () => {
          document.getElementById("search-input").value = "";
          document.getElementById("sort-status").value = "";
          loadBookings();
        });

        document.getElementById("sort-status").addEventListener("change", () => {
          const search = document.getElementById("search-input").value.trim();
          loadBookings({ search });
        });

        document.getElementById("bookings-tbody").addEventListener("click", (e) => {
          const saveBtn = e.target.closest(".save-status");

          if (saveBtn) {
            const id = saveBtn.getAttribute("data-id");
            const select = saveBtn
              .closest("td")
              .querySelector('.status-select[data-id="' + id + '"]');
            const status = select ? select.value : null;
            if (!status) return;

            const formData = new URLSearchParams();
            formData.append("action", "update_status");
            formData.append("id_booked", id);
            formData.append("status", status);

            fetchJson(BOOKINGS_API, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: formData.toString(),
            })
              .then(() => loadBookings())
              .catch((err) => alert(err.message));
          }
        });
      });
    </script>
  </body>
</html>


