<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SkySail Drones - Admin Bookings</title>
    <link rel="icon" href="./images/image-removebg-preview 2.png" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Montserrat", sans-serif;
      }
    </style>
  </head>
  <body class="bg-slate-950 text-slate-50 min-h-screen">
    <script src="./auth-role.js"></script>
    <script>
      requireRole("admin", {
        loginPath: "./login.html",
        forbiddenPath: "./index.html",
      });
    </script>

    <div class="min-h-screen flex flex-col">
      <header
        class="flex items-center justify-between px-6 py-4 bg-slate-900/80 border-b border-slate-800"
      >
        <a href="./admin-dashboard.html" class="flex items-center gap-2">
          <img src="./images/logolight.png" alt="SkySail Logo" class="h-10 w-auto" />
        </a>
        <div class="flex items-center gap-4 text-sm">
          <span id="admin-user-label" class="text-slate-300"></span>
          <button
            onclick="logoutAndRedirect('./login.html')"
            class="px-3 py-1.5 rounded-md bg-red-500/90 hover:bg-red-500 text-white font-medium text-xs transition"
          >
            Logout
          </button>
        </div>
      </header>

      <main class="flex-1 px-4 sm:px-6 lg:px-10 py-8 space-y-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h1 class="text-3xl font-semibold">Bookings Management</h1>
            <p class="text-slate-300 text-sm">
              View, filter, update status, and delete bookings via the API.
            </p>
          </div>
        </div>

        <!-- Search / Filter -->
        <section class="bg-slate-900/70 border border-slate-800 rounded-xl p-4">
          <form
            id="filter-form"
            class="flex flex-col gap-3 md:flex-row md:items-center md:gap-4"
          >
            <div class="flex-1">
              <input
                id="search-input"
                type="text"
                placeholder="Search by customer name or email..."
                class="w-full rounded-md border border-slate-700 bg-slate-950/40 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-purple-500"
              />
            </div>
            <div class="w-full md:w-52">
              <select
                id="status-filter"
                class="w-full rounded-md border border-slate-700 bg-slate-950/40 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-purple-500"
              >
                <option value="">All Statuses</option>
                <option value="Pending">Pending</option>
                <option value="Accepted">Accepted</option>
                <option value="Returned">Returned</option>
                <option value="Returned Damaged">Returned Damaged</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <button
              type="submit"
              class="px-4 py-2 rounded-md bg-purple-600 hover:bg-purple-700 text-xs font-medium"
            >
              Search
            </button>
            <button
              type="button"
              id="clear-filters"
              class="px-3 py-2 rounded-md bg-slate-800 hover:bg-slate-700 text-xs font-medium"
            >
              Clear
            </button>
          </form>
        </section>

        <!-- Bookings Table -->
        <section class="bg-slate-900/70 border border-slate-800 rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-800 text-sm" id="bookings-table">
              <thead class="bg-slate-900/90 text-slate-300 text-xs uppercase">
                <tr>
                  <th class="px-4 py-3 text-left">Customer</th>
                  <th class="px-4 py-3 text-left">Items</th>
                  <th class="px-4 py-3 text-left">Return</th>
                  <th class="px-4 py-3 text-left">Status</th>
                  <th class="px-4 py-3 text-left">Price</th>
                  <th class="px-4 py-3 text-left">Actions</th>
                </tr>
              </thead>
              <tbody id="bookings-tbody" class="divide-y divide-slate-800 bg-slate-950/40">
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-slate-400 text-sm">
                    Loading bookings...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <script>
      const API_BASE = "https://skysaildrone.solof.shop";
      const BOOKINGS_API = API_BASE + "/api-bookings.php";

      function formatMoney(value) {
        const num = Number(value || 0);
        return "₱" + num.toLocaleString("en-PH", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function formatDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        if (isNaN(d)) return dateStr;
        return d.toLocaleString("en-PH", {
          month: "short",
          day: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function calculatePenalty(booking) {
        // Only calculate penalty if booking is not returned
        if (booking.Status === "Returned" || booking.Status === "Returned Damaged" || booking.Status === "Cancelled") {
          return { penalty: 0, daysOverdue: 0 };
        }

        if (!booking.return_date) {
          return { penalty: 0, daysOverdue: 0 };
        }

        const returnDate = new Date(booking.return_date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        returnDate.setHours(0, 0, 0, 0);

        // Check if overdue
        if (returnDate >= today) {
          return { penalty: 0, daysOverdue: 0 };
        }

        // Calculate days overdue
        const daysOverdue = Math.floor((today - returnDate) / (1000 * 60 * 60 * 24));
        
        // Penalty: 10% of booking price per day overdue
        const penaltyRate = 0.1; // 10% per day
        const penalty = parseFloat(booking.price || 0) * penaltyRate * daysOverdue;

        return { penalty, daysOverdue };
      }

      async function fetchJson(url, options = {}) {
        const res = await fetch(url, options);
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
          throw new Error(data.message || "Request failed");
        }
        return data;
      }

      async function loadBookings(params = {}) {
        const tbody = document.getElementById("bookings-tbody");
        tbody.innerHTML =
          '<tr><td colspan="6" class="px-4 py-6 text-center text-slate-400 text-sm">Loading bookings...</td></tr>';

        const query = new URLSearchParams({ action: "list", ...params });

        try {
          const data = await fetchJson(BOOKINGS_API + "?" + query.toString());
          const bookings = data.bookings || [];

          if (bookings.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-400 text-sm">No bookings found.</td></tr>';
            return;
          }

          tbody.innerHTML = "";
          bookings.forEach((b) => {
            const penaltyInfo = calculatePenalty(b);
            const totalAmount = parseFloat(b.price || 0) + penaltyInfo.penalty;
            
            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-900/60 transition";

            const statusClasses =
              b.Status === "Accepted"
                ? "bg-emerald-500/15 text-emerald-300"
                : b.Status === "Pending"
                ? "bg-amber-500/15 text-amber-300"
                : b.Status === "Returned"
                ? "bg-sky-500/15 text-sky-300"
                : b.Status === "Returned Damaged"
                ? "bg-red-500/15 text-red-300"
                : "bg-slate-700/60 text-slate-200";

            tr.innerHTML = `
              <td class="px-4 py-3">
                <div class="font-medium text-sm">${b.FirstName} ${b.LastName}</div>
                <div class="text-xs text-slate-400">${b.username}</div>
              </td>
              <td class="px-4 py-3 text-xs">
                <div class="font-medium">${b.item_names || "Drone Rental"}</div>
                <div class="text-slate-400">Qty: ${b.quantity}</div>
                ${penaltyInfo.daysOverdue > 0 ? `<div class="text-red-400 font-semibold mt-1">⚠️ Overdue: ${penaltyInfo.daysOverdue} day${penaltyInfo.daysOverdue > 1 ? 's' : ''}</div>` : ''}
              </td>
              <td class="px-4 py-3 text-xs">
                <div>${b.return_date || ""} ${b.return_time || ""}</div>
                <div class="text-slate-400">${formatDate(b.checkout_date)}</div>
              </td>
              <td class="px-4 py-3 text-xs">
                <span class="inline-flex px-2 py-1 rounded-full text-[11px] font-semibold ${statusClasses}">
                  ${b.Status}
                </span>
              </td>
              <td class="px-4 py-3 text-sm">
                <div class="font-semibold text-purple-300">${formatMoney(b.price)}</div>
                ${penaltyInfo.penalty > 0 ? `<div class="text-red-400 text-xs">Penalty: ${formatMoney(penaltyInfo.penalty)}</div>` : ''}
                ${penaltyInfo.penalty > 0 ? `<div class="font-semibold text-purple-200 mt-1">Total: ${formatMoney(totalAmount)}</div>` : ''}
              </td>
              <td class="px-4 py-3 text-xs">
                <div class="flex flex-col gap-1">
                  <select
                    class="status-select w-full rounded-md border border-slate-700 bg-slate-950/60 px-2 py-1 text-[11px] focus:outline-none focus:ring-1 focus:ring-purple-500"
                    data-id="${b.id_booked}"
                  >
                    <option value="Pending" ${b.Status === "Pending" ? "selected" : ""}>Pending</option>
                    <option value="Accepted" ${b.Status === "Accepted" ? "selected" : ""}>Accepted</option>
                    <option value="Returned" ${b.Status === "Returned" ? "selected" : ""}>Returned</option>
                    <option value="Returned Damaged" ${
                      b.Status === "Returned Damaged" ? "selected" : ""
                    }>Returned Damaged</option>
                    <option value="Cancelled" ${b.Status === "Cancelled" ? "selected" : ""}>Cancelled</option>
                  </select>
                  <div class="flex gap-2">
                    <button
                      class="save-status px-2 py-1 rounded bg-purple-600 hover:bg-purple-700 text-[11px] font-medium"
                      data-id="${b.id_booked}"
                    >
                      Save
                    </button>
                    <button
                      class="delete-booking px-2 py-1 rounded bg-red-600/80 hover:bg-red-600 text-[11px] font-medium"
                      data-id="${b.id_booked}"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              </td>
            `;

            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          tbody.innerHTML =
            '<tr><td colspan="6" class="px-4 py-8 text-center text-red-300 text-sm">Failed to load bookings.</td></tr>';
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const user = getCurrentUser();
        if (user) {
          const el = document.getElementById("admin-user-label");
          if (el) {
            el.textContent = `${user.first_name || ""} ${user.last_name || ""} (${user.email})`;
          }
        }

        loadBookings();

        document.getElementById("filter-form").addEventListener("submit", (e) => {
          e.preventDefault();
          const search = document.getElementById("search-input").value.trim();
          const status = document.getElementById("status-filter").value;
          loadBookings({ search, status });
        });

        document.getElementById("clear-filters").addEventListener("click", () => {
          document.getElementById("search-input").value = "";
          document.getElementById("status-filter").value = "";
          loadBookings();
        });

        document.getElementById("bookings-tbody").addEventListener("click", (e) => {
          const saveBtn = e.target.closest(".save-status");
          const delBtn = e.target.closest(".delete-booking");

          if (saveBtn) {
            const id = saveBtn.getAttribute("data-id");
            const select = saveBtn
              .closest("td")
              .querySelector('.status-select[data-id="' + id + '"]');
            const status = select ? select.value : null;
            if (!status) return;

            const formData = new URLSearchParams();
            formData.append("action", "update_status");
            formData.append("id_booked", id);
            formData.append("status", status);

            fetchJson(BOOKINGS_API, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: formData.toString(),
            })
              .then(() => loadBookings())
              .catch((err) => alert(err.message));
          }

          if (delBtn) {
            const id = delBtn.getAttribute("data-id");
            if (!confirm("Are you sure you want to delete this booking?")) return;

            const formData = new URLSearchParams();
            formData.append("action", "delete");
            formData.append("id_booked", id);

            fetchJson(BOOKINGS_API, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: formData.toString(),
            })
              .then(() => loadBookings())
              .catch((err) => alert(err.message));
          }
        });
      });
    </script>
  </body>
</html>


