<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>SkySail Drones - Login</title>
        <link rel="icon" href="./images/image-removebg-preview 2.png">

        <!-- Fonts - Montserrat (similar to Gotham) -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

        <!-- Scripts -->
        <!-- Tailwind CSS CDN -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Montserrat', 'sans-serif'],
                        },
                    }
                }
            }
        </script>
        
        <style>
            body {
                font-family: 'Montserrat', sans-serif;
            }
            .auth-gradient {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .glass-card {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.3);
            }
        </style>
    </head>
    <body class="font-sans antialiased">
        <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 relative overflow-hidden" style="background-image: url('./images/Signin.png'); background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed;">
            <!-- Blurred overlay for better readability -->
            <div class="absolute inset-0 bg-black/20 backdrop-blur-sm"></div>

            <!-- Logo/Navigation - Light logo for dark gradient background -->
            <div class="absolute top-6 left-6 z-10">
                <a href="./index.html" class="flex items-center space-x-2 text-white hover:text-white/80 transition">
                    <img src="./images/logolight.png" alt="SkySail Logo" class="h-14 w-auto">
                    
                </a>
            </div>

            <div class="max-w-md w-full relative z-10">
                <div class="bg-white rounded-lg shadow-2xl p-10">
                    <div class="w-full">
                        <!-- Title -->
                        <h2 class="text-3xl font-normal text-gray-900 mb-8">Log in to SkySail</h2>

                        <form id="loginForm" method="POST" action="#" class="space-y-6">
                            <!-- Email Address -->
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email address</label>
                                <input id="email" 
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-gray-900 py-3 px-4 text-base" 
                                       type="email" 
                                       name="email" 
                                       required 
                                       autofocus 
                                       autocomplete="username"
                                       placeholder="Enter your email address" />
                            </div>

                            <!-- Password -->
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <div class="relative">
                                    <input id="password" 
                                           class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-gray-900 pr-10 py-3 px-4 text-base"
                                           type="password"
                                           name="password"
                                           required 
                                           autocomplete="current-password"
                                           placeholder="Enter your password" />
                                    <button type="button" 
                                            onclick="togglePassword()"
                                            class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600">
                                        <svg id="eye-icon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        <svg id="eye-off-icon" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Forgot Password Link -->
                            <div class="text-right">
                                <a class="text-sm text-blue-600 hover:text-blue-800 font-medium transition" 
                                   href="./forgot-password.html">
                                    Forgot password? Go to reset >
                                </a>
                            </div>

                            <!-- Submit Button -->
                            <div>
                                <button type="submit" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-4 rounded-md transition">
                                    Log In
                                </button>
                            </div>

                            <!-- Status / Error Message -->
                            <div id="loginMessage" class="text-sm text-center text-gray-600"></div>

                            <!-- Resend Verification Email Button (hidden by default) -->
                            <div id="resendVerificationContainer" class="hidden mt-3">
                                <button type="button" id="resendVerificationBtn" class="w-full text-sm text-blue-600 hover:text-blue-800 font-medium transition underline">
                                    Resend Verification Email
                                </button>
                                <div id="resendMessage" class="text-xs text-center mt-2"></div>
                            </div>

                            <!-- Register Link -->
                            <div class="text-center pt-4">
                                <p class="text-sm text-gray-600">
                                    New user? 
                                    <a href="./register.html" class="text-blue-600 hover:text-blue-800 font-medium transition">
                                        Create Your SkySail Account
                                    </a>
                                </p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Hostinger API base and endpoint
            const API_BASE = 'https://skysaildrone.solof.shop';
            const LOGIN_ENDPOINT = API_BASE + '/api-login.php';
            const VERIFY_EMAIL_API = API_BASE + '/api-email-verify.php';
            
            // Store email for resend verification
            let unverifiedEmail = null;

            function togglePassword() {
                const passwordInput = document.getElementById('password');
                const eyeIcon = document.getElementById('eye-icon');
                const eyeOffIcon = document.getElementById('eye-off-icon');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeIcon.classList.add('hidden');
                    eyeOffIcon.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    eyeIcon.classList.remove('hidden');
                    eyeOffIcon.classList.add('hidden');
                }
            }

            // Handle login submission via API to Hostinger
            document.getElementById('loginForm').addEventListener('submit', async function (event) {
                event.preventDefault();

                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                const messageEl = document.getElementById('loginMessage');

                if (!email || !password) {
                    messageEl.textContent = 'Please enter both email and password.';
                    messageEl.classList.remove('text-green-600');
                    messageEl.classList.add('text-red-600');
                    return;
                }

                messageEl.textContent = 'Logging in...';
                messageEl.classList.remove('text-red-600', 'text-green-600');
                messageEl.classList.add('text-gray-600');

                try {
                    const response = await fetch(LOGIN_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({ email, password }).toString(),
                    });

                    if (!response.ok) {
                        const errorText = await response.text().catch(() => '');
                        let errorData = {};
                        try {
                            errorData = JSON.parse(errorText);
                        } catch (e) {
                            // Not JSON
                        }
                        
                        // Check if it's an email verification error
                        const errorMessage = errorData.message || '';
                        const isVerificationError = response.status === 403 || 
                                                   errorData.email_not_verified || 
                                                   errorMessage.toLowerCase().includes('verify your email') ||
                                                   errorMessage.toLowerCase().includes('verification') ||
                                                   errorMessage.toLowerCase().includes('expired');
                        
                        if (isVerificationError) {
                            messageEl.textContent = 'Please try again. Please verify your email address before logging in. Check your inbox for the verification link.';
                            messageEl.classList.remove('text-gray-600', 'text-green-600');
                            messageEl.classList.add('text-red-600');
                            
                            // Store email and show resend button
                            unverifiedEmail = email;
                            document.getElementById('resendVerificationContainer').classList.remove('hidden');
                            document.getElementById('resendMessage').textContent = '';
                            return;
                        }
                        
                        throw new Error(errorData.message || `Login failed with status ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Login response:', data);

                    if (data.success) {
                        messageEl.textContent = 'Login successful. Redirecting...';
                        messageEl.classList.remove('text-gray-600');
                        messageEl.classList.add('text-green-600');

                        // Store basic user info in localStorage
                        if (data.user) {
                            // Ensure we have id_user (map from id if needed for compatibility)
                            const userToStore = { ...data.user };
                            
                            // Map id to id_user if present
                            if (userToStore.id && !userToStore.id_user) {
                                userToStore.id_user = userToStore.id;
                            }
                            
                            // Also keep id for compatibility
                            if (userToStore.id_user && !userToStore.id) {
                                userToStore.id = userToStore.id_user;
                            }
                            
                            console.log('Storing user:', userToStore);
                            console.log('User ID check - id:', userToStore.id, 'id_user:', userToStore.id_user);
                            
                            // If no ID is present, try to fetch it from users API
                            if (!userToStore.id && !userToStore.id_user) {
                                console.warn('WARNING: User object has no ID field! Attempting to fetch from API...', userToStore);
                                
                                // Try to get user ID from users API
                                if (userToStore.email || userToStore.username) {
                                    try {
                                        const searchTerm = userToStore.email || userToStore.username;
                                        const usersResponse = await fetch(API_BASE + '/api-users.php?action=list&search=' + encodeURIComponent(searchTerm));
                                        const usersData = await usersResponse.json().catch(() => ({}));
                                        const users = usersData.users || [];
                                        
                                        if (users.length > 0) {
                                            const foundUser = users.find(u => 
                                                (u.email === userToStore.email || u.username === userToStore.email || u.username === userToStore.username)
                                            );
                                            
                                            if (foundUser && foundUser.id_user) {
                                                console.log('Found user ID from API:', foundUser.id_user);
                                                userToStore.id_user = foundUser.id_user;
                                                userToStore.id = foundUser.id_user;
                                            }
                                        }
                                    } catch (err) {
                                        console.error('Failed to fetch user ID from API:', err);
                                    }
                                }
                            }
                            
                            localStorage.setItem('skysail_user', JSON.stringify(userToStore));
                            
                            // Verify it was stored correctly
                            const stored = localStorage.getItem('skysail_user');
                            const parsed = JSON.parse(stored);
                            console.log('Stored user:', parsed);
                            console.log('Stored user ID check - id:', parsed.id, 'id_user:', parsed.id_user);
                            
                            if (!parsed.id && !parsed.id_user) {
                                console.error('ERROR: User stored without ID after attempting to fetch!');
                                messageEl.textContent = 'Login successful but unable to retrieve user ID. Please try again.';
                                messageEl.classList.remove('text-gray-600', 'text-green-600');
                                messageEl.classList.add('text-red-600');
                                return;
                            }
                        } else {
                            console.error('No user object in response');
                            messageEl.textContent = 'Login response missing user data.';
                            messageEl.classList.remove('text-gray-600', 'text-green-600');
                            messageEl.classList.add('text-red-600');
                            return;
                        }

                        // Redirect based on role
                        setTimeout(() => {
                            const role = data.user?.role || 'user';

                            if (role === 'admin') {
                                window.location.href = './admin-dashboard.html';
                            } else if (role === 'employee') {
                                window.location.href = './employee-dashboard.html';
                            } else {
                                // Default: redirect all users (including 'user' role) to client dashboard
                                window.location.href = './client-dashboard.html';
                            }
                        }, 800);
                    } else {
                        messageEl.textContent = data.message || 'Login failed. Please check your credentials.';
                        messageEl.classList.remove('text-gray-600', 'text-green-600');
                        messageEl.classList.add('text-red-600');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    
                    // Check if error message contains email verification info (including expired tokens)
                    const errorMsg = error.message || '';
                    const isVerificationError = errorMsg.toLowerCase().includes('verify your email') ||
                                               errorMsg.toLowerCase().includes('verification') ||
                                               errorMsg.toLowerCase().includes('expired');
                    
                    if (isVerificationError) {
                        messageEl.textContent = 'Please try again. Please verify your email address before logging in. Check your inbox for the verification link.';
                        
                        // Store email and show resend button
                        unverifiedEmail = email;
                        document.getElementById('resendVerificationContainer').classList.remove('hidden');
                        document.getElementById('resendMessage').textContent = '';
                    } else {
                        messageEl.textContent = error.message || 'Login failed. Please try again.';
                        // Hide resend button for non-verification errors
                        document.getElementById('resendVerificationContainer').classList.add('hidden');
                    }
                    
                    messageEl.classList.remove('text-gray-600', 'text-green-600');
                    messageEl.classList.add('text-red-600');
                }
            });

            // Handle resend verification email
            document.getElementById('resendVerificationBtn').addEventListener('click', async function() {
                if (!unverifiedEmail) {
                    unverifiedEmail = document.getElementById('email').value.trim();
                }
                
                if (!unverifiedEmail) {
                    document.getElementById('resendMessage').textContent = 'Please enter your email address first.';
                    document.getElementById('resendMessage').classList.remove('text-green-600');
                    document.getElementById('resendMessage').classList.add('text-red-600');
                    return;
                }
                
                const resendBtn = document.getElementById('resendVerificationBtn');
                const resendMessage = document.getElementById('resendMessage');
                
                resendBtn.disabled = true;
                resendBtn.textContent = 'Sending...';
                resendMessage.textContent = '';
                
                try {
                    const formData = new URLSearchParams();
                    formData.append('action', 'send');
                    formData.append('email', unverifiedEmail);
                    
                    const response = await fetch(VERIFY_EMAIL_API, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: formData.toString(),
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        resendMessage.textContent = 'Verification email sent! Please check your inbox.';
                        resendMessage.classList.remove('text-red-600');
                        resendMessage.classList.add('text-green-600');
                        resendBtn.textContent = 'Email Sent âœ“';
                        
                        // Hide button after 5 seconds
                        setTimeout(() => {
                            resendBtn.textContent = 'Resend Verification Email';
                            resendBtn.disabled = false;
                        }, 5000);
                    } else {
                        resendMessage.textContent = data.message || 'Failed to send verification email. Please try again.';
                        resendMessage.classList.remove('text-green-600');
                        resendMessage.classList.add('text-red-600');
                        resendBtn.textContent = 'Resend Verification Email';
                        resendBtn.disabled = false;
                    }
                } catch (error) {
                    resendMessage.textContent = 'Failed to send verification email. Please try again.';
                    resendMessage.classList.remove('text-green-600');
                    resendMessage.classList.add('text-red-600');
                    resendBtn.textContent = 'Resend Verification Email';
                    resendBtn.disabled = false;
                }
            });
            
            // Hide resend button when user starts typing or changes email
            document.getElementById('email').addEventListener('input', function() {
                document.getElementById('resendVerificationContainer').classList.add('hidden');
                unverifiedEmail = null;
            });
        </script>
    </body>
</html>

